#Scraping para proyectos de inversión pública
#Nivel de gobierno: Gobierno Nacional

library(tidyverse)
library(xml2)
library(rvest)
library(RSelenium)
library(wdman)
library(robotstxt)
library(openxlsx)

#---- Rselenium y rvest #----

#URL DE CONSULTA AMIGABLE -TRANSFERENCIA ECONÓMICA -PERÚ
URLm<-"https://apps5.mineco.gob.pe/transparencia/mensual/default.aspx?y="   # Actualización mensual
#URLd<-"https://apps5.mineco.gob.pe/transparencia/navegador/default.aspx?y=" #Actualización diaria

# Para seguimiento de proyectos de inversión:
#https://www.gob.pe/802-seguimiento-de-la-ejecucion-presupuestal-consulta-amigable
#"https://apps5.mineco.gob.pe/bingos/seguimiento_pi/Navegador/default.aspx?y="

#paths_allowed(paths = c(URLm)) # debió decir TRUE

options(encoding = "utf-8") # Le asignamos el encoding

#Abrimos una sesión en la web
# Ejecutamos el servidor phantomjs -creamos un navegador fantasma

server <- phantomjs(port=5012L)
#Abrimos el navegador
Browser <- remoteDriver(browserName = "phantomjs", port=5012L)
Browser$open()

#Navegar la página web que guardamos indicandole los años y tipo de información
# Años 2010:2020
Years <- c(2017:2021) #Cinco años
Years[1]
#Tipo de informacíon
TipoInfo<-c("ActProy","Actividad","Proyecto") #Actividades/Proyectos, sólo actividades, sólo proyectos
TipoInfo[3]
#Navegamos
Browser$navigate(paste0(URLm,Years[5],"&ap=",TipoInfo[3])) #Cambiar año
Browser$screenshot(display=TRUE)

#Ubicamos el frame donde están los botones
frame0 <- Browser$findElement(value='//*[@id="frame0"]')
#Activamos el Frame
Browser$switchToFrame(frame0)

# Hacer clic en niveles de gobierno
NivelesGobierno <- Browser$findElement(using = "css",
                                     value = "#ctl00_CPH1_BtnTipoGobierno") #Es Id
NivelesGobierno$clickElement()
Browser$screenshot(display=TRUE) # si salío 

#Hacer clic en opción de E:Gobierno Nacional
GobiernoNacional <- Browser$findElement(using = "css",
                                      value = "#ctl00_CPH1_RptData_ctl01_TD0") #Es Id
GobiernoNacional$clickElement()
Browser$screenshot(display=TRUE) # 

# Hacer clic en Departamento
Depart <- Browser$findElement(using = "css",
                            value = "#ctl00_CPH1_BtnDepartamentoMeta") #Es Id
Depart$clickElement()
Browser$screenshot(display=TRUE) # 

#----Prueba #----
#Raspamos inversión pública-nivel gobierno nacional para todas las regiones
#Decirle que actúe sobre la página actual para rasparlo
Pagina_actual <- Browser$getPageSource()

#escrapeamos la información de todas las regiones
Pagina <- read_html(Pagina_actual[[1]]) # en el elemento 1 de la lista está la url de la página actual

EGNacional <- Pagina%>%
  html_node(css = "#ctl00_CPH1_UpdatePanel1")%>% #ctl00_CPH1_UpdatePanel1
  html_node(css = ".Data")%>%
  html_table(header = F)

#Cambiamos los nombres de las variables
names(EGNacional)[2:10] <- c("Departamento","PIA","PIM","Certificacion","CompAnual",
                           "AtenDeComprMensual","Devengado","Girado","Avance%")
EGNacional <- EGNacional[,-1]             #Nos quedamos con las variables que tienen información1
#Agregamos dos campos mas
EGNacional <- EGNacional%>%
  mutate(NivelGobierno="Gobierno Nacional",
         Year=Years[1])
#Un poco de limpieza
EGNacional[,1] <- sapply(EGNacional[,1], function(x) str_remove_all(x,pattern = "[:digit:]"))
EGNacional[,1] <- sapply(EGNacional[,1], function(x) str_remove_all(x,pattern = "[:punct:]"))
EGNacional[,1] <- sapply(EGNacional[,1], function(x) str_to_title(x,locale = "en"))
EGNacional[,1] <- sapply(EGNacional[,1], function(x) str_trim(x))


#Guardamos la información
#saveRDS(EGNacional,file = "EG_GN.rds")
#Hacemos una lista de los departamentos
Departs <- EGNacional$Departamento
# Extraemos los proyectos de inversión pública de todos los departamentos del GN

#---- Hcer clic en Amazonas #----
#   Ejemplo
#ctl00_CPH1_RptData_ctl01_TD0
Departamento <- Browser$findElement(using = "css",
                         value = "#ctl00_CPH1_RptData_ctl01_TD0") #Es Id
Departamento$clickElement()
Browser$screenshot(display=TRUE) 

# Hacer clic en Producto/Proyecto
ProdProyec <- Browser$findElement(using = "css",
                                value = "#ctl00_CPH1_BtnProdProy") #Es Id
ProdProyec$clickElement()
Browser$screenshot(display=TRUE)

#Raspamos información de Proyectos
#Nuevamente decirle que actúe sobre página actual
Pagina_actual <- Browser$getPageSource()

Pagina <- read_html(Pagina_actual[[1]])

DataProyectosGN <- Pagina%>%
  html_node(css = "#ctl00_CPH1_UpdatePanel1")%>%
  html_node(css = ".Data")%>%
  html_table(header = F,fill=T)

#Cambiamos los nombres de las variables
names(DataProyectosGN)[2:10] <- c("ProductoProyecto","PIA","PIM","Certificación","CompAnual",
                          "AtenDeComprMensual","Devengado","Girado","Avance%")
DataProyectosGN <- DataProyectosGN[,-1] #Nos quedamos con las variables que tienen información
DataProyectosGN <- DataProyectosGN%>%
  filter(!ProductoProyecto=="Ficha de Proyecto")
# DataProyectosGN <- DataProyectosGN[!DataProyectosGN$ProductoProyecto=="Ficha de Proyecto",] #Elemina las filas con ese patrón

DataProyectosGN <- DataProyectosGN%>%
  mutate(NivelGobierno="Gobierno Nacional",
         Departamento=Departs[1],
         Year=Years[1])

#---- Bucle para todos los Departamentos #----
#Ya esta para amazonas 2017
#Falta 2018 al 2021

for(i in c(1:26)) {
  #count
  j <- str_pad(i,2,pad="0")
  print(j)
  # Hacer clic en los Departamentos del GN
  Departamento <- Browser$findElement("id", paste0("ctl00_CPH1_RptData_ctl",j,"_TD0")) #Es Id
  Departamento$clickElement()
  #Browser$screenshot(display=TRUE)
  # Hacer clic en Producto/Proyecto
  ProdProyec <- Browser$findElement(using = "css",value = "#ctl00_CPH1_BtnProdProy") #Es Id
  ProdProyec$clickElement()
  
  #Raspamos información de Proyectos
  #Decirle que actúe sobre página actual
  Pagina_actual <- Browser$getPageSource()
  #Leer la página
  Proyectos <- read_html(Pagina_actual[[1]])%>%
    html_node(css = "#ctl00_CPH1_UpdatePanel1")%>%
    html_node(css = ".Data")%>%
    html_table(header = F,fill=T)
  
  #Cambiamos los nombres de las variables
  names(Proyectos)[2:10]<-c("ProductoProyecto","PIA","PIM","Certificación","CompAnual",
                            "AtenDeComprMensual","Devengado","Girado","Avance%")
  Proyectos <- Proyectos[,-1]             #Nos quedamos con las variables que tienen información
  Proyectos <- Proyectos[!Proyectos$ProductoProyecto=="Ficha de Proyecto",] #Elemina las filas con ese patrón
  Proyectos <- Proyectos%>%
    mutate(NivelGobierno="Gobierno Nacional",
           Departamento=Departs[i],
           Year=2021) #Rellena el departamento correspondiente 2017:2021
  
  #Ahora que junte la informacion con rbind
  DataProyectosGN <- rbind(DataProyectosGN,Proyectos)
  #Hacer clic al botón Regresar
  Retroceder <- Browser$findElement("id","ctl00_CPH1_RptHistory_ctl03_TD0")
  Retroceder$clickElement()
  #Que descance un rato
  Sys.sleep(5)
}

#ctl00_CPH1_RptHistory_ctl03_TD0
length(unique(DataProyectosGN$ProductoProyecto))
#Guardamos toda la data
saveRDS(DataProyectosGN,"Data/DataProyectosGN.rds")
#cerrar la sesión
Browser$close()
server$stop()

#Leer la data
DataProyectosGN <- readRDS(file ="Data/DataProyectosGN.rds")
#Guardar en excel
write.xlsx(DataProyectosGN,file ="Data/DataProyectosGN.xlsx")
