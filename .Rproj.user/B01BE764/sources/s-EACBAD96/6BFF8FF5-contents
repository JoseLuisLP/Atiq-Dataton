#Scraping para proyectos de inversión pública
#Nivel de gobierno: Gobierno Regional
#

library(xml2)
library(rvest)
library(RSelenium)
library(wdman)
library(robotstxt)
library(tidyverse)
library(openxlsx)
#Ulr de consulta amigable-Mensual
UrlMef <- "https://apps5.mineco.gob.pe/transparencia/mensual/default.aspx?y="

#2010&ap=ActProy"

#paths_allowed(paths = c(URL)) # debió decir TRUE

options(encoding = "utf-8") # Le asignamos el encoding

#Abrimos una sesion en la web
# Ejecutamos el servidor phantomjs -creamos un navegador fantasma

server <- phantomjs(port=5012L)
#Abrimos el navegador
Browser <- remoteDriver(browserName = "phantomjs", port=5012L)
Browser$open()

#Navegar la página web que guardamos indicandole los años y tipo de información
# Años
Years <- c(2017:2021)
Years[5]
#Tipo de informacíon
TipoInfo <- c("ActProy","Actividad","Proyecto") #Actividades/Proyectos, sólo actividades, sólo proyectos
TipoInfo[3]

#---- Data anual #----
#---- Inversion total Gobierno Nivel regional #----
Browser$navigate(paste0(UrlMef,Years[1],"&ap=",TipoInfo[3])) #Solo cambiar año 
Browser$screenshot(display=TRUE)

#Ubicamos el frame donde están los botones
frame0 <- Browser$findElement(value='//*[@id="frame0"]')
#Activamos el Frame
Browser$switchToFrame(frame0)

#Inicia el proceso de Scraping general
# Hacer clic en nivel de gobierno
NivelesGobierno <- Browser$findElement(using = "css",
                                     value = "#ctl00_CPH1_BtnTipoGobierno") #Es Id
NivelesGobierno$clickElement()
Browser$screenshot(display=TRUE) # si salío 

#Hacer clic en opción de R:Gobiernos Regionales
GobiernoRegional <- Browser$findElement(using = "css",
                                      value = "#ctl00_CPH1_RptData_ctl03_TD0") #Es Id
GobiernoRegional$clickElement()
Browser$screenshot(display=TRUE) #

#Hacer clic en departamentos
Departamentos <- Browser$findElement(using = "css",
                                   value = "#ctl00_CPH1_BtnDepartamentoMeta") #Es Id
Departamentos$clickElement()
Browser$screenshot(display=TRUE)

#Decirle que actúe sobre la página actual para rasparlo
Pagina_actual <- Browser$getPageSource()

#escrapeamos la información de todas las regiones
Pagina <- read_html(Pagina_actual[[1]]) # en el elemento 1 de la lista está la url de la página actual

InvTotalRegion <- Pagina%>%
  html_node(css = "#ctl00_CPH1_UpdatePanel1")%>%
  html_node(css = ".Data")%>%
  html_table(header = F)
#Cambiamos los nombres de las variables
names(InvTotalRegion)[2:10] <- c("Departamento","PIA","PIM","Certificacion","CompAnual",
                                  "AtenDeComprMensual","Devengado","Girado","Avance%")

InvTotalRegion <- InvTotalRegion[,-1]             #Nos quedamos con las variables que tienen información
#Agregamos dos campos mas
InvTotalRegion <- InvTotalRegion%>%
  mutate(NivelGobierno="Gobierno Regional",
         Year=Years[1])
#Un poco de limpieza
InvTotalRegion[,1] <- sapply(InvTotalRegion[,1], function(x) str_remove_all(x,pattern = "[:digit:]"))
InvTotalRegion[,1] <- sapply(InvTotalRegion[,1], function(x) str_remove_all(x,pattern = "[:punct:]"))
InvTotalRegion[,1] <- sapply(InvTotalRegion[,1], function(x) str_to_title(x,locale = "en"))
InvTotalRegion[,1] <- sapply(InvTotalRegion[,1], function(x) str_trim(x))
#Obtenemos los nombres de las regiones
Regiones <- InvTotalRegion$Departamento

#Scraping para el Primer año y región Amazonas
# Extraemos los proyectos de inversión pública de todos los departamentos del GR

#---- Hcer clic en Amazonas #----
#   Ejemplo
#ctl00_CPH1_RptData_ctl01_TD0
Departamento <- Browser$findElement(using = "css",
                                    value = "#ctl00_CPH1_RptData_ctl01_TD0") #Es Id
Departamento$clickElement()
Browser$screenshot(display=TRUE) 

# Hacer clic en Producto/Proyecto
ProdProyec <- Browser$findElement(using = "css",
                                  value = "#ctl00_CPH1_BtnProdProy") #Es Id
ProdProyec$clickElement()
Browser$screenshot(display=TRUE)

#Raspamos información de Proyectos
#Nuevamente decirle que actúe sobre página actual
Pagina_actual <- Browser$getPageSource()

Pagina <- read_html(Pagina_actual[[1]])

DataProyectosGR <- Pagina%>%
  html_node(css = "#ctl00_CPH1_UpdatePanel1")%>%
  html_node(css = ".Data")%>%
  html_table(header = F,fill=T)

#Cambiamos los nombres de las variables
names(DataProyectosGR)[2:10] <- c("ProductoProyecto","PIA","PIM","Certificacion","CompAnual",
                                  "AtenDeComprMensual","Devengado","Girado","Avance%")
DataProyectosGR <- DataProyectosGR[,-1] #Nos quedamos con las variables que tienen información
DataProyectosGR <- DataProyectosGR%>%
  filter(!ProductoProyecto=="Ficha de Proyecto")
#Agregamos tres campos
DataProyectosGR <- DataProyectosGR%>%
  mutate(NivelGobierno="Gobierno Regional",
         Departamento=Regiones[1],
         Year=Years[1])

#---- Bucle por año y Departamentos #----
#For para los demas años (2017:2021) y Departamentos [1:25]
#Para año (1:5)
for (j in 2:5) {
  
  print(j)
  #Navegamos
  Browser$navigate(paste0(UrlMef,Years[j],"&ap=",TipoInfo[3])) #Solo cambiar año 
  #Ubicamos el frame donde están los botones
  frame0 <- Browser$findElement(value='//*[@id="frame0"]')
  #Activamos el Frame
  Browser$switchToFrame(frame0)
  #
  # Hacer clic en nivel de gobierno
  NivelesGobierno <- Browser$findElement(using = "css",
                                         value = "#ctl00_CPH1_BtnTipoGobierno") #Es Id
  NivelesGobierno$clickElement()
 
  #Hacer clic en opción de R:Gobiernos Regionales
  GobiernoRegional <- Browser$findElement(using = "css",
                                          value = "#ctl00_CPH1_RptData_ctl03_TD0") #Es Id
  GobiernoRegional$clickElement()
  
  #Hacer clic en departamentos
  Departamentos <- Browser$findElement(using = "css",
                                       value = "#ctl00_CPH1_BtnDepartamentoMeta") #Es Id
  Departamentos$clickElement()
  
  #Bucle para departamentos (1:25)
  for (i in 1:25) {
    jj <- str_pad(i,2,pad="0")
    print(jj)
    # Hacer clic en los Departamentos del GR
    Departamento <- Browser$findElement("id", paste0("ctl00_CPH1_RptData_ctl",jj,"_TD0")) #Es Id
    Departamento$clickElement()
  
    # Hacer clic en Producto/Proyecto
    ProdProyec <- Browser$findElement(using = "css",value = "#ctl00_CPH1_BtnProdProy") #Es Id
    ProdProyec$clickElement()
    
    #Raspamos información de Proyectos
    #Decirle que actúe sobre página actual
    Pagina_actual <- Browser$getPageSource()
    #Leer la página
    Proyectos <- read_html(Pagina_actual[[1]])%>%
      html_node(css = "#ctl00_CPH1_UpdatePanel1")%>%
      html_node(css = ".Data")%>%
      html_table(header = F,fill=T)
    
    #Cambiamos los nombres de las variables
    names(Proyectos)[2:10] <- c("ProductoProyecto","PIA","PIM","Certificacion","CompAnual",
                              "AtenDeComprMensual","Devengado","Girado","Avance%")
    Proyectos <- Proyectos[,-1]             #Nos quedamos con las variables que tienen información
    Proyectos <- Proyectos[!Proyectos$ProductoProyecto=="Ficha de Proyecto",] #Elemina las filas con ese patrón
    Proyectos <- Proyectos%>%
      mutate(NivelGobierno="Gobierno Regional",
             Departamento=Regiones[i],
             Year=Years[j]) #Rellena el departamento correspondiente 2017:2021
    
    #Ahora que junte la informacion con rbind
    DataProyectosGR <- rbind(DataProyectosGR,Proyectos)
    #Hacer clic al botón Regresar
    Retroceder <- Browser$findElement("id","ctl00_CPH1_RptHistory_ctl03_TD0")
    Retroceder$clickElement()
    #Que descance un rato
    Sys.sleep(4)
  }
  
  #Descansar un rato
  Sys.sleep(5)
}


#Guardar la toda la información
saveRDS(DataProyectosGR,file = "Data/DataProyectosGobR.rds") #

length(unique(DataProyectosGR$ProductoProyecto))

##cerrar la sesión
Browser$close()
server$stop()

#Leer el archivo
DataProyectosGR <- readRDS(file = "Data/DataProyectosGR.rds")
#Guardar en excel
write.xlsx(DataProyectosGR,file ="Data/DataProyectosGobR.xlsx")
